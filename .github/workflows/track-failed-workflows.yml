---
name: Track Failed Workflows

'on':
  workflow_run:
    workflows: ["*"]
    types:
      - completed

permissions:
  issues: write
  actions: read
  contents: read

jobs:
  track-failures:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Check if issue already exists
        id: check-issue
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'workflow-failure',
              per_page: 100
            });

            const workflowName = context.payload.workflow_run.name;
            const runId = context.payload.workflow_run.id;
            const headBranch = context.payload.workflow_run.head_branch;

            // Check if an issue already exists for this workflow failure
            const existingIssue = issues.find(issue =>
              issue.title.includes(workflowName) &&
              issue.title.includes(headBranch)
            );

            core.setOutput('exists', existingIssue ? 'true' : 'false');
            core.setOutput('issue_number', existingIssue ? existingIssue.number : '');

            return {
              exists: !!existingIssue,
              issue_number: existingIssue ? existingIssue.number : null,
              workflow_name: workflowName,
              run_id: runId,
              head_branch: headBranch
            };

      - name: Create issue for failed workflow
        if: steps.check-issue.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const workflowRun = context.payload.workflow_run;
            const pullRequests = workflowRun.pull_requests || [];
            const prLinks = pullRequests.map(pr => `#${pr.number}`).join(', ');

            const issueBody = `## Workflow Failure Report
            
            **Workflow**: ${workflowRun.name}
            **Branch**: ${workflowRun.head_branch}
            **Commit**: ${workflowRun.head_sha.substring(0, 7)}
            **Run ID**: ${workflowRun.id}
            **Triggered by**: @${workflowRun.triggering_actor.login}
            ${prLinks ? `**Pull Request(s)**: ${prLinks}` : ''}
            
            ### Details
            - **Run URL**: ${workflowRun.html_url}
            - **Event**: ${workflowRun.event}
            - **Conclusion**: ${workflowRun.conclusion}
            - **Created**: ${workflowRun.created_at}
            
            ### Action Required
            Please investigate the workflow failure and fix the underlying issue.
            
            ---
            *This issue was automatically created by the Track Failed Workflows action.*`;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Workflow Failure] ${workflowRun.name} on ${workflowRun.head_branch}`,
              body: issueBody,
              labels: ['workflow-failure', 'automated']
            });

            console.log(`Created issue #${issue.data.number}`);
            return issue.data.number;

      - name: Update existing issue
        if: steps.check-issue.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.check-issue.outputs.issue_number }}');
            const workflowRun = context.payload.workflow_run;

            const comment = `### Workflow failed again
            
            **Run ID**: ${workflowRun.id}
            **Commit**: ${workflowRun.head_sha.substring(0, 7)}
            **Run URL**: ${workflowRun.html_url}
            **Triggered by**: @${workflowRun.triggering_actor.login}
            **Time**: ${workflowRun.created_at}
            
            The workflow is still failing. Please investigate.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });

            console.log(`Updated issue #${issueNumber} with new failure information`);
